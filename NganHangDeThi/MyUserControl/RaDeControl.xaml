<UserControl x:Class="NganHangDeThi.MyUserControl.RaDeControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:NganHangDeThi.MyUserControl" 
             xmlns:Icon="http://metro.mahapps.com/winfx/xaml/iconpacks" 
             xmlns:local1="clr-namespace:NganHangDeThi.Converters"
             d:DataContext="{d:DesignInstance Type=local:RaDeControl}"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />
        <local1:TrangThaiLopHocConverter x:Key="TrangThaiConverter" />
        <local1:IndexConverter x:Key="IndexConverter" />
        <local1:DeGocVisibilityConverter x:Key="DeGocVisibilityConverter" />
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!--Title-->
        <TextBlock Text="Soạn và quản lý đề thi" Grid.Row="0" 
                   FontSize="32" FontWeight="SemiBold" Margin="0 0 0 4"
                   HorizontalAlignment="Left" Foreground="#121518"/>

        <!--Tab control-->
        <TabControl Grid.Row="1" Style="{StaticResource TabControlStyle}" SelectionChanged="TabControl_SelectionChanged">
            <TabItem x:Name="TabDeThi" Header="Đề thi" Style="{StaticResource TabItemStyle}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="auto" />
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="auto"/>
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0 0 0 10">
                        <Button Background="#cccccc" Foreground="#000000" Click="BtnXoaBoLoc_Click" Width="100" Style="{StaticResource AddButton}" Margin="0 0 20 0">
                            <StackPanel Orientation="Horizontal">
                                <Icon:PackIconMaterial Kind="FilterRemove" VerticalAlignment="Center" Width="11" Height="11" Margin="0 1 8 0" />
                                <TextBlock Text="Xóa lọc" />
                            </StackPanel>
                        </Button>

                        <TextBlock Text="Khoa" FontFamily="13" FontWeight="SemiBold" Margin="0 0 10 0"
                        Foreground="#121518" HorizontalAlignment="Left" VerticalAlignment="Center" />

                        <ComboBox Style="{StaticResource ComboBoxFlatStyle}" Width="180" Margin="0 0 20 0"
                           ItemsSource="{Binding DsKhoa}"
                           SelectedItem="{Binding KhoaLoc, UpdateSourceTrigger=PropertyChanged}"
                           DisplayMemberPath="TenKhoa" />

                        <TextBlock Text="Lớp học" FontFamily="13" FontWeight="SemiBold" Margin="0 0 10 0"
                        Foreground="#121518" HorizontalAlignment="Left" VerticalAlignment="Center" />

                        <ComboBox Style="{StaticResource ComboBoxFlatStyle}" Width="150" Margin="0 0 20 0"
                           ItemsSource="{Binding DsLopHoc}"
                           SelectedItem="{Binding LopHocLoc, UpdateSourceTrigger=PropertyChanged}"
                           DisplayMemberPath="MaLop" />

                        <TextBlock Text="Tìm kiếm" FontFamily="13" FontWeight="SemiBold" Margin="0 0 10 0"
                       Foreground="#121518" HorizontalAlignment="Left" VerticalAlignment="Center" />

                        <Grid Width="200">
                            <TextBox x:Name="TxtFilterBox" 
                                 Tag="Nhập tiêu đề đề thi..."
                                 Text="{Binding TuKhoaTimKiemDeThi, UpdateSourceTrigger=PropertyChanged}" 
                                 Style="{StaticResource TextBoxFilter}" />
                        </Grid>
                    </StackPanel>

                    <DataGrid Grid.Row="1" ItemsSource="{Binding DeThiView}" CanUserSortColumns="False"
                        RowStyle="{DynamicResource DataGridRowStyle1}" 
                        ColumnHeaderStyle="{DynamicResource DataGridColumnHeaderStyle1}" 
                        CellStyle="{DynamicResource DataGridCellStyle1}" 
                        Style="{DynamicResource DataGridStyle1}"
                              
                            EnableRowVirtualization="True"
                          VirtualizingPanel.IsVirtualizing="True"
                          VirtualizingPanel.IsVirtualizingWhenGrouping="True" 
                          VirtualizingPanel.VirtualizationMode="Recycling"
                          VirtualizingPanel.ScrollUnit="Pixel">

                        <DataGrid.GroupStyle>
                            <GroupStyle>
                                <GroupStyle.ContainerStyle>
                                    <Style TargetType="{x:Type GroupItem}">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="{x:Type GroupItem}">
                                                    <StackPanel>
                                                        <Expander IsExpanded="True" BorderThickness="0 0 0 1" BorderBrush="#E0E0E0">
                                                            <Expander.Header>
                                                                <!--<Grid Width="{Binding RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type Expander}}, Path=ActualWidth}">-->
                                                                <Grid>
                                                                    <Grid.ColumnDefinitions>
                                                                        <ColumnDefinition Width="*"/>
                                                                        <ColumnDefinition Width="Auto"/>
                                                                    </Grid.ColumnDefinitions>

                                                                    <StackPanel Orientation="Horizontal" Height="30" VerticalAlignment="Center">
                                                                        <TextBlock Text="{Binding Items[0].CreatedAt, StringFormat='Đợt tạo: {0:dd/MM/yyyy HH:mm:ss}'}" 
                                                       FontWeight="Bold" Foreground="#0C5776" FontSize="14" VerticalAlignment="Center"/>
                                                                        <TextBlock Text="{Binding ItemCount, StringFormat=' (Số lượng: {0} đề)'}" 
                                                       FontStyle="Italic" Foreground="#666" VerticalAlignment="Center" Margin="5 0 0 0"/>
                                                                    </StackPanel>

                                                                    <Button Grid.Column="1" Content="Xuất bộ đề này" 
                                                                        Name="BtnXuatBoDe" Click="BtnXuatBoDe_Click" 
                                                                        Tag="{Binding Items[0]}" 
                                                                        Margin="20 0 40 0" Style="{StaticResource AddButton}" Width="120" Height="26" FontSize="12"/>
                                                                </Grid>
                                                            </Expander.Header>
                                                            <Expander.Content>
                                                                <ItemsPresenter />
                                                            </Expander.Content>
                                                        </Expander>
                                                    </StackPanel>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </GroupStyle.ContainerStyle>
                            </GroupStyle>
                        </DataGrid.GroupStyle>

                        <DataGrid.Columns>
                            <DataGridTextColumn Header="#" Binding="{Binding Id}" Visibility="Collapsed" IsReadOnly="True" CanUserResize="False" Width="auto" />
                            <!--<DataGridTextColumn Header="Tiêu đề" Binding="{Binding TieuDe}" IsReadOnly="True" Width="auto" />-->
                            <DataGridTemplateColumn Header="Tiêu đề" IsReadOnly="True" Width="*" MinWidth="350">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Grid VerticalAlignment="Center">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <TextBlock Grid.Column="0" 
                           Text="{Binding TieuDe}" 
                           VerticalAlignment="Center" 
                           TextTrimming="CharacterEllipsis" 
                           ToolTip="{Binding TieuDe}" 
                           Padding="5 0 5 0"
                           FontSize="14"/>

                                            <Border Grid.Column="1" 
                                                    Background="#e3f2fd" CornerRadius="4" Margin="0 0 5 0" Padding="8 2"
                                                    BorderBrush="#2196f3" BorderThickness="1"
                                                    Visibility="{Binding GhiChu, Converter={StaticResource DeGocVisibilityConverter}}">
                                                <StackPanel Orientation="Horizontal">
                                                    <Icon:PackIconMaterial Kind="Star" Width="10" Height="10" VerticalAlignment="Center" Foreground="#1976d2" Margin="0 0 4 0"/>
                                                    <TextBlock Text="ĐỀ GỐC" FontSize="10" FontWeight="Bold" Foreground="#1976d2" VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </Border>

                                        </Grid>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTextColumn Header="Kỳ thi" Binding="{Binding KyThi}" IsReadOnly="True" Width="auto" />
                            <DataGridTextColumn Header="Thời gian làm bài" Binding="{Binding ThoiGianLamBai}" IsReadOnly="True" Width="auto" />
                            <DataGridTextColumn Header="Ngày tạo" Binding="{Binding CreatedAt}" IsReadOnly="True" Width="auto" />
                            <DataGridTextColumn Header="Môn" Binding="{Binding MonHoc.TenMon}" IsReadOnly="True" Width="auto" />
                            <DataGridTextColumn Header="Lớp" Binding="{Binding LopHoc.MaLop}" IsReadOnly="True" Width="auto" />
                            <DataGridTemplateColumn Header="Thao tác" IsReadOnly="True" Width="Auto">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Button Name="BtnXuatDeThi" Click="BtnXuatDeThi_Click" Style="{StaticResource GridEditButton}" Tag="{Binding}" ToolTip="Xuất ra Word" Margin="0 0 5 0">
                                                <Icon:PackIconMaterial Kind="FileWordBox" Style="{StaticResource GridButtonIcon}" />
                                            </Button>
                                            <Button Name="BtnXoaDeThi" Click="BtnXoaDeThi_Click" Style="{StaticResource GridRemoveButton}" Tag="{Binding}" ToolTip="Xóa" Margin="5 0 0 0">
                                                <Icon:PackIconMaterial Kind="DeleteOffOutline" Style="{StaticResource GridButtonIcon}" />
                                            </Button>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Grid.Row="2">
                        <Button Name="BtnTaiLaiDeThi" Click="BtnTaiLaiDeThi_Click" Style="{StaticResource AddButton}" Margin="0 0 4 0">
                            <StackPanel Orientation="Horizontal">
                                <Icon:PackIconMaterial Kind="Refresh" VerticalAlignment="Center" Width="11" Height="11" Margin="0 1 8 0" />
                                <TextBlock Text="Tải lại" />
                            </StackPanel>
                        </Button>
                        <Button Name="BtnTaoDeThi" Click="BtnTaoDeThi_Click" Style="{StaticResource AddButton}" Margin="0 0 20 0">
                            <StackPanel Orientation="Horizontal">
                                <Icon:PackIconMaterial Kind="Plus" VerticalAlignment="Center" Width="11" Height="11" Margin="0 1 8 0" />
                                <TextBlock Text="Tạo đề thi" />
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>
            </TabItem>

            <TabItem x:Name="TabMaTran" Header="Ma trận" Style="{StaticResource TabItemStyle}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <StackPanel Orientation="Horizontal" Grid.Row="0">
                        <!--Muốn thêm gì thêm-->
                    </StackPanel>

                    <StackPanel HorizontalAlignment="Right" Orientation="Horizontal" Grid.Row="0">
                        <!--Refresh Button-->
                        <Button Name="BtnTaiLaiMaTran" Click="BtnTaiLaiMaTran_Click" Style="{StaticResource AddButton}" Margin="0 0 4 0">
                            <StackPanel Orientation="Horizontal">
                                <Icon:PackIconMaterial Kind="Refresh" VerticalAlignment="Center" Width="11" Height="11" Margin="0 1 8 0" />
                                <TextBlock Text="Tải lại" />
                            </StackPanel>
                        </Button>

                        <!--Add Button-->
                        <Button Name="BtnThemMaTran" Click="BtnThemMaTran_Click" Style="{StaticResource AddButton}">
                            <StackPanel Orientation="Horizontal">
                                <Icon:PackIconMaterial Kind="Plus" VerticalAlignment="Center" Width="11" Height="11" Margin="0 1 8 0" />
                                <TextBlock Text="Thêm" />
                            </StackPanel>
                        </Button>
                    </StackPanel>

                    <DataGrid ItemsSource="{Binding MaTranView}"
                              RowStyle="{DynamicResource DataGridRowStyle1}" 
                              ColumnHeaderStyle="{DynamicResource DataGridColumnHeaderStyle1}" 
                              CellStyle="{DynamicResource DataGridCellStyle1}" 
                              Style="{DynamicResource DataGridStyle1}">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="#" Binding="{Binding Id}" Visibility="Collapsed" IsReadOnly="True" CanUserResize="False" Width="auto" />
                            <DataGridTextColumn Header="Tên" Binding="{Binding Name}" IsReadOnly="True" Width="auto" />
                            <DataGridTextColumn Header="Ngày chỉnh sửa gần nhất" Binding="{Binding ThoiGianCapNhatGanNhat}" IsReadOnly="True" Width="auto" />
                            <DataGridTextColumn Header="Ngày tạo" Binding="{Binding CreatedAt}" IsReadOnly="True" Width="auto" />

                            <DataGridTemplateColumn Header="Thao tác" IsReadOnly="True" Width="*">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Button Name="BtnSuaMaTran" Click="BtnSuaMaTran_Click" Style="{StaticResource GridEditButton}" Tag="{Binding}" ToolTip="Sửa" Margin="5 0 0 0">
                                                <Icon:PackIconMaterial Kind="PencilOffOutline" Style="{StaticResource GridButtonIcon}" />
                                            </Button>
                                            <Button Name="BtnXoaMaTran" Click="BtnXoaMaTran_Click" Style="{StaticResource GridRemoveButton}" Tag="{Binding}" ToolTip="Xóa" Margin="5 0 0 0">
                                                <Icon:PackIconMaterial Kind="DeleteOffOutline" Style="{StaticResource GridButtonIcon}" />
                                            </Button>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </TabItem>
        </TabControl>
    </Grid>
</UserControl>
